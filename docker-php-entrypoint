#!/bin/bash

# set reasonable defaults for msmtp

MSMTP_SERVER=${SSMTP_SERVER:-mailhog}
MSMTP_PORT=${SSMTP_PORT:-1025}

cat << EOF > /etc/msmtprc
# Set defaults.
defaults
# Enable or disable TLS/SSL encryption.
tls on
tls_starttls on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
# Setup WP account's settings.
account 
host $MSMTP_SERVER
port $MSMTP_PORT
auth off
user 
password 
from 
logfile /var/log/msmtp/msmtp.log

account default : 

EOF

_gotpl() {
    if [[ -f "/etc/gotpl/$1" ]]; then
        gotpl "/etc/gotpl/$1" > "$2"
    fi
}

process_templates() {
    _gotpl "vhost.conf.tmpl" "/etc/apache2/sites-available/000-default.conf"
	_gotpl "vhostssl.conf.tmpl" "/etc/apache2/sites-available/default-ssl.conf"
	_gotpl "php.settings.tmpl" "/usr/local/etc/php/conf.d/custom-php-settings.ini"
}

process_templates


# https://github.com/docker-library/php/blob/master/7.3/buster/apache/docker-php-entrypoint
# Add default official image command

# first arg is `-f` or `--some-option`
if [ "${1#-}" != "$1" ]; then
	set -- apache2-foreground "$@"
fi

exec "$@"